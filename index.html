
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
        <link rel="next" href="download/">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>Animal Detection</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#animal-detector" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Animal Detection" class="md-header__button md-logo" aria-label="Animal Detection" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Animal Detection
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Animal Detection" class="md-nav__button md-logo" aria-label="Animal Detection" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Animal Detection
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Home
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-origin" class="md-nav__link">
    Data Origin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-download-observations" class="md-nav__link">
    1. Download Observations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mega-detector-animal-detection" class="md-nav__link">
    2. Mega-detector Animal Detection
  </a>
  
    <nav class="md-nav" aria-label="2. Mega-detector Animal Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-mega-detector-use" class="md-nav__link">
    Example Mega-detector Use
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-create-sub-images" class="md-nav__link">
    3. Create Sub-images
  </a>
  
    <nav class="md-nav" aria-label="3. Create Sub-images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sub-image-example" class="md-nav__link">
    Sub-image Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-taxonomic-directory-structure" class="md-nav__link">
    4. Taxonomic Directory Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output" class="md-nav__link">
    Output
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-layout" class="md-nav__link">
    Project layout
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="download/" class="md-nav__link">
        1.Download Observations Docs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="mega_detector/" class="md-nav__link">
        2.Mega-detector Animal Detection
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="cropping/" class="md-nav__link">
        3.Create Sub-images
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="taxon_directory/" class="md-nav__link">
        4.Taxonomic Directory Structure Docs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#data-origin" class="md-nav__link">
    Data Origin
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-download-observations" class="md-nav__link">
    1. Download Observations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mega-detector-animal-detection" class="md-nav__link">
    2. Mega-detector Animal Detection
  </a>
  
    <nav class="md-nav" aria-label="2. Mega-detector Animal Detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-mega-detector-use" class="md-nav__link">
    Example Mega-detector Use
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-create-sub-images" class="md-nav__link">
    3. Create Sub-images
  </a>
  
    <nav class="md-nav" aria-label="3. Create Sub-images">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sub-image-example" class="md-nav__link">
    Sub-image Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-taxonomic-directory-structure" class="md-nav__link">
    4. Taxonomic Directory Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#output" class="md-nav__link">
    Output
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-layout" class="md-nav__link">
    Project layout
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="animal-detector">Animal Detector</h1>
<p>This repository serves 4 purposes arranged in sequential steps: </p>
<ol>
<li>
<p>Download the raw observation images from iNaturalist observations. </p>
</li>
<li>
<p>Execute Mega-detector object detection to identify individual animal instances</p>
</li>
<li>
<p>Crop Mega-detector animal instanced into sub-images</p>
</li>
<li>
<p>Arrange each sub-image into a taxonomic directory structure. </p>
</li>
</ol>
<p>The below headings provide information on how to execute each step, what the process entails, and what the expected
output should be. This page provides additional links to the repositories providing the observations data, and the repositories
using the resulting data. </p>
<h2 id="data-origin">Data Origin</h2>
<p>Please use the <code>&lt;dataset_name&gt;_train.csv</code> file that is located within the <a href="https://github.com/Spatiotemporal-Wildlife-Classification/Wildlife-Classification">Wildlife Classification</a>
repository. The data is produced as part of the data preparation process. Please consult the README and the documentation of that repository
for further information. The link to the documentation is as follows: <a href="https://spatiotemporal-wildlife-classification.github.io/Wildlife-Classification/">https://spatiotemporal-wildlife-classification.github.io/Wildlife-Classification/</a></p>
<h2 id="1-download-observations">1. Download Observations</h2>
<p>This process aims to download the observations from the iNaturalist observation urls. </p>
<p>The <code>raw_data_access.py</code> file is responsible for raw image downloads. 
Please perform the following steps to download the raw images for an iNaturalist observations CSV file.</p>
<ol>
<li>Load the <code>&lt;observations&gt;.csv</code> file into the <code>observations/</code> directory. <ul>
<li>In this case, it is the <code>proboscidia_train.csv</code> file. This file is available at a public Dataset: <a href="https://www.kaggle.com/datasets/travisdaws/spatiotemporal-wildlife-dataset">https://www.kaggle.com/datasets/travisdaws/spatiotemporal-wildlife-dataset</a></li>
</ul>
</li>
<li>Specify the name of the observation file on line 90.</li>
<li>Execute the file. The progress bar will update you on the status of the download.</li>
</ol>
<p>Please access the <a href="download/">Download Observations Documentation</a> for the documentation.</p>
<h2 id="2-mega-detector-animal-detection">2. Mega-detector Animal Detection</h2>
<p>This process makes use of <a href="https://github.com/microsoft/CameraTraps/blob/main/megadetector.md">Mega-detector</a>.
The below documentation is based off the provided instructions in the <a href="https://github.com/microsoft/CameraTraps/blob/main/megadetector.md">Mega-detector</a> README file.
To detect and place bounding boxes around individual animal instances within a raw image. 
The bounding boxes, serve as the boundaries around which the images are cropped to produce sub-images per observation. 
A certainty of 75% is enforced for each animal detection. 
Each sub-image has the naming format: <Observation id>_<sub_image_char>.png
where <sub_image_char> is a letter of the alphabet corresponding to the number of sub-images already extracted.</p>
<p>Please note that Mega-detector is capable of detecting animals, vehicles, and humans. In this case we only extract the sub-image
if it is the type animal.</p>
<p>Please perform the following steps: 
1. Download the <a href="https://github.com/ecologize/CameraTraps/releases/download/v5.0/md_v5a.0.0.pt">MDvA5</a> file to your computer. 
    - It must be saved in the following directory: <code>megadetector/</code> at you home folder.
2. Clone the following repositories into the project. These will replace the empty directories in the project: 
   <code>angular2html
   git clone https://github.com/ecologize/yolov5/
   git clone https://github.com/ecologize/CameraTraps
   git clone https://github.com/Microsoft/ai4eutils</code></p>
<ol>
<li>Navigate into the <code>CameraTraps</code> directory and execute the following<ul>
<li>Remove the <code>opencv=4.5.5</code> in the <code>envs/environment-detector.yml</code></li>
<li><code>conda env create --file envs/environment-detector.yml</code></li>
</ul>
</li>
<li>Activate the virtual environment:</li>
<li><code>conda activate cameratraps-detector</code></li>
<li>Add additional package</li>
<li><code>pip install ultralytics</code></li>
<li>Add the packages to your Python path: 
   <code>angular2html
   export PYTHONPATH="$PYTHONPATH:$HOME/path/to/Animal-Detector/CameraTraps:$HOME/path/to/Animal-Detector/ai4eutils:$HOME/path/to/Animal-Detector/yolov5"</code>
   Please see the below example:
   <code>angular2html
   export PYTHONPATH="$PYTHONPATH:$HOME/Desktop/git_store/Animal-Detector/CameraTraps:$HOME/Desktop/git_store/Animal-Detector/ai4eutils:$HOME/Desktop/git_store/Animal-Detector/yolov5"</code></li>
<li>Check Mega-detector.</li>
<li>Navigate into the <code>CameraTraps</code> directory.</li>
<li>Run the following script to check Mega-detectors output on a single image of your choice: 
   <code>angular2html
   python detection\run_detector.py "c:\megadetector\md_v5a.0.0.pt" --image_file "some_image_file.jpg" --threshold 0.1</code></li>
</ol>
<p>This should produce a file in the same location with the format <name>_detections.jpg.
   This file will contain the bounding-box drawn on image an animal, vehicle or person was detected.
8. To run a batch detection on the <code>dataimages/raw/</code> directory perform the following: 
   - Create a file in the project root called <code>bounding_boxes.json</code>
   - Execute the following from terminal. Make sure you are in the <code>CameraTraps</code> directory
   <code>angular2html
   python detection/run_detector_batch.py "$HOME/megadetector/md_v5a.0.0.pt" "$HOME/path/to/Animal-Detector/data/images/raw/" "$HOME/Desktop/git_store/Animal-Detector/bounding_boxes.json" --threshold 0.85 --output_relative_filenames --recursive --checkpoint_frequency 10000</code></p>
<p>An example is below:
   <code>angular2html
   python detection/run_detector_batch.py "$HOME/megadetector/md_v5a.0.0.pt" "$HOME/Desktop/git_store/Animal-Detector/data/images/raw/" "$HOME/Desktop/git_store/Animal-Detector/bounding_boxes.json" --threshold 0.85 --output_relative_filenames --recursive --checkpoint_frequency 10000</code></p>
<p>The object identification labels, and bounding box dimensions are written to the <code>bounding_boxes.json</code> file.</p>
<p>Please note, when wanting to use the Mega-detector functionality, steps 4 and 5 must be repeated.</p>
<p>Please access the <a href="mega_detector/">Mega-detector Information</a></p>
<h4 id="example-mega-detector-use">Example Mega-detector Use</h4>
<p>The below images it the provided raw observation image. 
<img height="315" src="resources/raw.jpg" width="500" alt="Raw observation Image" style="display: block; margin: 0 auto"/></p>
<p>The below image, contains the raw image with object detection applied and illustrated by the red bonding-box. 
Each bounding-box contains the object detection's certainty of object class.
A certainty cut-off of 75% is used in the provided instructions.
<img height="315" src="resources/raw_detections.jpg" width="500" alt="Image Detections" style="display: block; margin: 0 auto"/></p>
<h2 id="3-create-sub-images">3. Create Sub-images</h2>
<p>The <code>detection_cropping.py</code> file is responsible for performing the sub-image cropping process.
The process makes use of the <code>bounding_boxes.json</code> file containing all Mega-detector detections.
The process, converts the provided bounding boxes for the <em>animal</em> category into coordinates within the image. 
The images is cropped based on these coordinates. The cropping reduces image resolution. 
To combat the loss of resolution Lanzos interpolation and edge sharpening kernels were used to enhance the resulting
sub-image. </p>
<p>Please perform the following steps to crop the images according to the Mega-detector object detections. 
1. Ensure steps 1 and 2 are completed and the results are in the specified directories. 
2. Simply run the script. 
   - The resulting cropped images will be placed within the <code>images/cropped/</code> directory.</p>
<h4 id="sub-image-example">Sub-image Example</h4>
<p>The images below showcase the original image, followed by the Mega-detector object detections.</p>
<div style="display: flex; justify-content: center;">
    <img src="resources/raw.jpg" alt="Image 1" style="width: 300px; height: 200px; margin-right: 10px;">
    <img src="resources/raw_detections.jpg" alt="Image 2" style="width: 300px; height: 200px;">
</div>

<p>The below images showcase the extracted sub-images.</p>
<div style="display: flex; justify-content: center;">
    <img src="resources/10006459_a.jpg" alt="Image 1" style="width: 300px; height: 200px; margin-right: 10px;">
    <img src="resources/10006459_b.jpg" alt="Image 2" style="width: 300px; height: 200px; margin-right: 10px;">
    <img src="resources/10006459_c.jpg" alt="Image 3" style="width: 300px; height: 200px;">
</div>

<h2 id="4-taxonomic-directory-structure">4. Taxonomic Directory Structure</h2>
<p>This final step places the sub-images into a directory that mimics the taxonomic structure of the dataset. 
This taxonomic structure enables the use of the keras <a href="https://www.tensorflow.org/api_docs/python/tf/keras/utils/image_dataset_from_directory"><code>image_dataset_from_directory()</code></a> method 
in the <a href="https://github.com/Spatiotemporal-Wildlife-Classification/Wildlife-Classification">Wildlife Classification</a>
repository. This enables automated image dataset construction and label inference based on the directory structure.
The images are split into training and validation sets. The validation set comprises 15% of the available data.</p>
<p>To create the taxonomic directory structure please follow the below steps:
1. Ensure steps 1-3 are completed and have produced the expected results.
2. Specify the dataset names on line 174. These datasets are what the dataset taxonomic structure is based on.
   - Note the names can also be specified one at a time. The result will be the same.
3. Execute the script. 
   - The output will be in the <code>images/taxon_structured/</code> directory.</p>
<p>The <code>taxon_train</code> and the <code>taxon_validate</code> directories inside the <code>data/images/taxon_structured</code> should be placed 
within the <code>data/images/</code> directory of the Wildlife Classification repository.</p>
<h2 id="output">Output</h2>
<p>The training and validation datasets organized within the taxonomic structure are used as the training and validation 
sets of the image classification model training in the <a href="https://github.com/Spatiotemporal-Wildlife-Classification/Wildlife-Classification">Wildlife Classification</a> Repository</p>
<p>For example, the <em>Elephantidae</em> and <em>Felidae</em> training taxonomic directory (to genus level) should resemble:
<img height="315" src="resources/tree.png" width="500" alt="Raw observation Image" style="display: block; margin: 0 auto"/></p>
<h2 id="project-layout">Project layout</h2>
<pre><code>ai4eutils/  # ai4eutils repository
CameraTraps/  # CameraTraps repository
data/  
docs/  
yolov5/  # Yolov5 repository
resources/  # Resources for documentation
bounding_boxes.json  # Step 2 resulting file
dataset_structure.py  # Step 4
detection_cropping.py  # Step 3
mkdocs.yml  # Documentation configuration
raw_data_access.py  # Step 1
README.md
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>